<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:entities="using:MaterialClient.Common.Entities"
        xmlns:models="using:MaterialClient.Common.Models"
        xmlns:vm="using:MaterialClient.ViewModels"
        xmlns:sys="clr-namespace:System;assembly=System.Runtime"
        xmlns:views="using:MaterialClient.Views"
        xmlns:converters="using:MaterialClient.Converters"
        x:Class="MaterialClient.Views.AttendedWeighingWindow"
        x:DataType="vm:AttendedWeighingViewModel"
        x:Name="AttendedWeighingWindowRoot"
        Title="有人值守"
        Width="1440" Height="900"
        WindowStartupLocation="CenterScreen"
        Icon="/Assets/fd-ico.ico">
  
  <Window.Resources>
    <converters:EqualityToColorConverter x:Key="EqualityToColorConverter"/>
    <converters:NullOrEmptyImageConverter x:Key="NullOrEmptyImageConverter"/>
    <converters:BoolToBrushConverter x:Key="BoolToBrushConverter"/>
  </Window.Resources>
  
  <!-- Window.Styles 已移至 App.axaml 全局样式 -->
  
  <Grid RowDefinitions="Auto,Auto,*,Auto" ColumnDefinitions="*">
    
    <!-- Top Blue Header Bar -->
    <Border Grid.Row="0" Background="#4169E1" Padding="16,12">
      <Grid ColumnDefinitions="Auto,*,Auto">
        <!-- Logo and Title -->
        <StackPanel Orientation="Horizontal" Spacing="12" VerticalAlignment="Center">
          <Image Source="/Assets/Indexlogo.png" Width="210" Height="32" Stretch="Uniform"/>
        </StackPanel>
        
        <!-- Menu Items (Center) -->
        <StackPanel Grid.Column="1" 
                    Orientation="Horizontal" 
                    Spacing="32" 
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center">
          <Button Content="数据管理" 
                  Classes="transparent-button"
                  Foreground="White" 
                  Padding="8,4"/>
          <Button Content="系统设置" 
                  Classes="transparent-button"
                  Foreground="White" 
                  Padding="8,4"
                  Command="{Binding OpenSettingsCommand}"/>
          <Button Content="项目信息" 
                  Classes="transparent-button"
                  Foreground="White" 
                  Padding="8,4"/>
          <Button Content="数据同步" 
                  Classes="transparent-button"
                  Foreground="White" 
                  Padding="8,4"/>
        </StackPanel>
        
      </Grid>
    </Border>

    <!-- Blue Gradient Weight Display Area -->
    <Grid Grid.Row="1" Background="#4A85F9">
      <!-- Background Image Layer -->
      <Border>
        <Border.Background>
          <ImageBrush Source="/Assets/Indexbanner.png" 
                      Stretch="UniformToFill"
                      AlignmentX="Center"
                      AlignmentY="Center"/>
        </Border.Background>
      </Border>
      
      <!-- Content Layer with Margin -->
      <Grid ColumnDefinitions="Auto,*,Auto" 
            Margin="24,32"
            HorizontalAlignment="Stretch" 
            VerticalAlignment="Stretch">
        <!-- Weight Display Center -->
        <Grid Grid.Column="1" 
              HorizontalAlignment="Center"
              ColumnDefinitions="Auto,Auto,Auto,Auto">
          <!-- Province Selector -->
          <Border Background="#5A7FE6" 
                  CornerRadius="8" 
                  Padding="20,12"
                  VerticalAlignment="Center"
                  MinWidth="180">
            <TextBlock Text="{Binding MostFrequentPlateNumber, TargetNullValue='--'}" 
                       Foreground="White" 
                       FontSize="16"/>
          </Border>
          
          <!-- DeliveryType Selector -->
          <Border Grid.Column="1"
                  Background="#5A7FE6"
                  CornerRadius="8"
                  Margin="16,0,0,0"
                  VerticalAlignment="Center">
            <StackPanel Orientation="Vertical">
              <RadioButton GroupName="DeliveryType"
                           IsChecked="{Binding IsReceiving}"
                           Command="{Binding SetReceivingCommand}"
                           Cursor="Hand">
                <RadioButton.Template>
                  <ControlTemplate TargetType="RadioButton">
                    <Border Name="bd" 
                            BorderThickness="1" 
                            CornerRadius="8,8,0,0"
                            BorderBrush="Transparent" 
                            Background="Transparent"
                            Padding="20,6">
                      <TextBlock Name="bdText" 
                                 Text="收料" 
                                 Foreground="#FFFFFF"
                                 FontSize="14" 
                                 VerticalAlignment="Center"
                                 HorizontalAlignment="Center"/>
                    </Border>
                  </ControlTemplate>
                </RadioButton.Template>
                <RadioButton.Styles>
                  <Style Selector="RadioButton:checked /template/ Border#bd">
                    <Setter Property="Background" Value="#FFFFFF"/>
                    <Setter Property="BorderBrush" Value="#FFFFFF"/>
                  </Style>
                  <Style Selector="RadioButton:checked /template/ TextBlock#bdText">
                    <Setter Property="Foreground" Value="#5A7FE6"/>
                  </Style>
                </RadioButton.Styles>
              </RadioButton>
              <RadioButton GroupName="DeliveryType"
                           IsChecked="{Binding IsSending}"
                           Command="{Binding SetSendingCommand}"
                           Cursor="Hand">
                <RadioButton.Template>
                  <ControlTemplate TargetType="RadioButton">
                    <Border Name="bd" 
                            BorderThickness="1" 
                            CornerRadius="0,0,8,8"
                            BorderBrush="Transparent" 
                            Background="Transparent"
                            Padding="20,6">
                      <TextBlock Name="bdText" 
                                 Text="发料" 
                                 Foreground="#FFFFFF"
                                 FontSize="14" 
                                 VerticalAlignment="Center"
                                 HorizontalAlignment="Center"/>
                    </Border>
                  </ControlTemplate>
                </RadioButton.Template>
                <RadioButton.Styles>
                  <Style Selector="RadioButton:checked /template/ Border#bd">
                    <Setter Property="Background" Value="#FFFFFF"/>
                    <Setter Property="BorderBrush" Value="#FFFFFF"/>
                  </Style>
                  <Style Selector="RadioButton:checked /template/ TextBlock#bdText">
                    <Setter Property="Foreground" Value="#5A7FE6"/>
                  </Style>
                </RadioButton.Styles>
              </RadioButton>
            </StackPanel>
          </Border>
          
          <!-- Weight Value -->
          <TextBlock Grid.Column="2" 
                     Text="{Binding CurrentWeight, StringFormat='{}{0:F2}'}" 
                     Foreground="White" 
                     FontSize="64" 
                     FontWeight="Bold"
                     VerticalAlignment="Center"
                     Margin="16,0"/>
          
          <!-- Unit -->
          <TextBlock Grid.Column="3" 
                     Text="吨" 
                     Foreground="White" 
                     FontSize="24"
                     VerticalAlignment="Center"
                     Margin="8,0,0,0"/>
        </Grid>
        
        <!-- Right Side Info -->
        <TextBlock Grid.Column="2" 
                   Text="{Binding CurrentWeighingStatusText}" 
                   Foreground="White" 
                   FontSize="18"
                   VerticalAlignment="Center"/>
      </Grid>
    </Grid>

    <!-- Main Content Area (White Background, Three Columns) -->
    <Grid Grid.Row="2" Background="White" ColumnDefinitions="300,*,380" Margin="0">
      
      <!-- Left Column: Record List -->
      <Border Grid.Column="0" 
              Background="#F8F9FA" 
              BorderBrush="#E5E7EB" 
              BorderThickness="0,0,1,0"
              Padding="0">
        <Grid RowDefinitions="Auto,Auto,*">
          <!-- Tab Headers -->
          <Border Grid.Row="0" Background="White" BorderBrush="#E5E7EB" BorderThickness="0,0,0,1">
            <StackPanel Orientation="Horizontal" Spacing="0">
              <Button Content="全部记录" 
                      Classes="tab-button"
                      Classes.active="{Binding IsShowAllRecords}"
                      BorderThickness="0,0,0,3"
                      Padding="24,12"
                      FontSize="14"
                      Command="{Binding ShowAllRecordsCommand}"/>
              <Button Content="未完成" 
                      Classes="tab-button"
                      Classes.active="{Binding IsShowUnmatched}"
                      BorderThickness="0,0,0,3"
                      Padding="24,12"
                      FontSize="14"
                      Command="{Binding ShowUnmatchedCommand}"/>
              <Button Content="已完成" 
                      Classes="tab-button"
                      Classes.active="{Binding IsShowCompleted}"
                      BorderThickness="0,0,0,3"
                      Padding="24,12"
                      FontSize="14"
                      Command="{Binding ShowCompletedCommand}"/>
            </StackPanel>
          </Border>
          
          <!-- Search Box -->
          <Border Grid.Row="1" 
                  Classes="card-border"
                  Margin="12,12,12,8"
                  Padding="12">
            <Grid RowDefinitions="Auto,Auto,Auto">
            
            <!-- Row 1: 进场时间 + 两个日期框 -->
            <Grid Grid.Row="0" 
                  ColumnDefinitions="Auto,Auto,Auto"
                  Margin="0,0,0,8">
              <TextBlock Text="进场时间" 
                         VerticalAlignment="Center" 
                         Margin="0,0,8,0"
                         FontSize="13"
                         Foreground="#666"/>
              <CalendarDatePicker Grid.Column="1"
                                  Width="80"
                                  FontSize="10"
                                  Watermark="YYYY/MM/DD"
                                  Margin="0,0,8,0"/>
              <CalendarDatePicker Grid.Column="2"
                                  Width="80"
                                  FontSize="10"
                                  Watermark="YYYY/MM/DD"/>
            </Grid>
            
            <!-- Row 2: 车牌号码 + 输入框 -->
            <Grid Grid.Row="1" 
                  ColumnDefinitions="Auto,Auto"
                  Margin="0,0,0,8">
              <TextBlock Text="车牌号码" 
                         VerticalAlignment="Center" 
                         Margin="0,0,8,0"
                         FontSize="13"
                         Foreground="#666"/>
              <TextBox Grid.Column="1"
                       Width="100"
                       FontSize="13"/>
            </Grid>
            
            <!-- Row 3: 搜索 + 重置按钮 -->
            <Grid Grid.Row="2" 
                  ColumnDefinitions="Auto,Auto">
              <Button Grid.Column="0" 
                      Content="搜索" 
                      Classes="primary-button"
                      CornerRadius="4"
                      Padding="20,6"
                      FontSize="13"
                      Margin="0,0,4,0"/>
              <Button Grid.Column="1" 
                      Content="重置" 
                      Classes="secondary-button"
                      CornerRadius="4"
                      Padding="20,6"
                      FontSize="13"/>
            </Grid>
            </Grid>
          </Border>
          
          <!-- Record List -->
          <Border Grid.Row="2" Classes="card-border" Margin="12,0,12,12">
            <Grid RowDefinitions="Auto,*,Auto">
              <!-- List Header -->
              <Border Background="#F8F9FA" 
                      BorderBrush="#E5E7EB" 
                      BorderThickness="0,0,0,1"
                      Padding="12,8">
                <Grid ColumnDefinitions="80,*,*">
                  <TextBlock Text="车牌" FontSize="13" FontWeight="SemiBold" Foreground="#666"/>
                  <TextBlock Grid.Column="1" Text="进场时间" FontSize="13" FontWeight="SemiBold" Foreground="#666"/>
                  <TextBlock Grid.Column="2" Text="出场时间" FontSize="13" FontWeight="SemiBold" Foreground="#666"/>
                </Grid>
              </Border>
              
              <!-- Scrollable List - 统一的列表 -->
              <ScrollViewer Grid.Row="1">
                <ItemsControl ItemsSource="{Binding PagedListItems}">
                  <ItemsControl.ItemTemplate>
                    <DataTemplate x:DataType="models:WeighingListItemDto">
                      <Button Classes="transparent-button"
                              BorderThickness="0,0,0,1"
                              BorderBrush="#F0F0F0"
                              Padding="12,12"
                              HorizontalAlignment="Stretch"
                              HorizontalContentAlignment="Stretch"
                              Command="{Binding $parent[ItemsControl].((vm:AttendedWeighingViewModel)DataContext).SelectListItemCommand}"
                              CommandParameter="{Binding}">
                        <Button.Background>
                          <MultiBinding Converter="{StaticResource EqualityToColorConverter}">
                            <Binding Path="." />
                            <Binding Path="$parent[ItemsControl].((vm:AttendedWeighingViewModel)DataContext).SelectedListItem" />
                          </MultiBinding>
                        </Button.Background>
                        <Grid ColumnDefinitions="80,*,*">
                          <TextBlock Text="{Binding PlateNumber, TargetNullValue='未识别'}" 
                                     FontSize="13"
                                     Foreground="#333"/>
                          <TextBlock Grid.Column="1" 
                                     Text="{Binding JoinTime, StringFormat='{}{0:MM-dd HH:mm}'}" 
                                     FontSize="13"
                                     Foreground="#666"/>
                          <TextBlock Grid.Column="2" 
                                     Text="{Binding OutTime, StringFormat='{}{0:MM-dd HH:mm}', TargetNullValue='-'}" 
                                     FontSize="13"
                                     Foreground="#666"/>
                        </Grid>
                      </Button>
                    </DataTemplate>
                  </ItemsControl.ItemTemplate>
                </ItemsControl>
              </ScrollViewer>
              
              <!-- Pagination Controls -->
              <Border Grid.Row="2" 
                      Background="#F8F9FA" 
                      BorderBrush="#E5E7EB" 
                      BorderThickness="0,1,0,0"
                      Padding="12,8">
                <Grid ColumnDefinitions="Auto,*,Auto,Auto">
                  <!-- 总记录数信息 -->
                  <TextBlock Grid.Column="0"
                             Text="{Binding TotalCount, StringFormat='共 {0} 条'}"
                             FontSize="12"
                             Foreground="#666"
                             VerticalAlignment="Center"
                             Margin="0,0,12,0"/>
                  
                  <!-- 页码信息 -->
                  <TextBlock Grid.Column="1"
                             HorizontalAlignment="Center"
                             VerticalAlignment="Center"
                             Text="{Binding PageInfoText}"
                             FontSize="12"
                             Foreground="#666"/>
                  
                  <!-- 上一页按钮 -->
                  <Button Grid.Column="2"
                          Content="上一页"
                          Command="{Binding GoToPreviousPageCommand}"
                          Classes="outline-button"
                          CornerRadius="4"
                          Padding="12,6"
                          FontSize="12"
                          Margin="0,0,8,0"/>
                  
                  <!-- 下一页按钮 -->
                  <Button Grid.Column="3"
                          Content="下一页"
                          Command="{Binding GoToNextPageCommand}"
                          Classes="outline-button"
                          CornerRadius="4"
                          Padding="12,6"
                          FontSize="12"/>
                </Grid>
              </Border>
            </Grid>
          </Border>
        </Grid>
      </Border>

      <!-- Middle Column: Material Info and Photos (动态切换视图) -->
      <Grid Grid.Column="1">
        <!-- 主视图 -->
        <views:AttendedWeighingMainView DataContext="{Binding}" 
                                         IsVisible="{Binding #AttendedWeighingWindowRoot.((vm:AttendedWeighingViewModel)DataContext).IsShowingMainView}"/>
        
        <!-- 详情视图 -->
        <views:AttendedWeighingDetailView DataContext="{Binding DetailViewModel}"
                                           IsVisible="{Binding #AttendedWeighingWindowRoot.((vm:AttendedWeighingViewModel)DataContext).IsShowingDetailView}"/>
      </Grid>

      <!-- Right Column: Camera Views and Bill -->
      <Border Grid.Column="2" 
              Background="#F8F9FA" 
              BorderBrush="#E5E7EB" 
              BorderThickness="1,0,0,0"
              Padding="20">
        <Grid RowDefinitions="Auto,Auto,Auto,Auto,*,Auto">
          <!-- Photo Grid View -->
          <views:PhotoGridView Grid.RowSpan="2" DataContext="{Binding PhotoGridViewModel}"/>
          
          <!-- Bill Scan Section -->
          <TextBlock Grid.Row="2" 
                     Text="单据扫描" 
                     FontSize="14" 
                     FontWeight="SemiBold"
                     Margin="0,24,0,12"/>
          
          <Border Grid.Row="3" 
                  Classes="card-border"
                  Height="240"
                  Padding="16">
            <Grid RowDefinitions="*,Auto">
              <Border Background="#F0F0F0" 
                      CornerRadius="4"
                      BorderBrush="#D1D5DB"
                      BorderThickness="1">
                <Image Source="{Binding BillPhotoPath}" 
                       Stretch="Uniform"
                       HorizontalAlignment="Center"
                       VerticalAlignment="Center"/>
              </Border>
              
              <Button Grid.Row="1" 
                      Content="拍照" 
                      Classes="success-button"
                      CornerRadius="6"
                      Padding="48,8"
                      HorizontalAlignment="Center"
                      Margin="0,12,0,0"
                      Command="{Binding TakeBillPhotoCommand}"/>
            </Grid>
          </Border>
        </Grid>
      </Border>
      
    </Grid>
    
    <!-- Status Bar -->
    <Border Grid.Row="3" 
            Background="#F5F5F5" 
            BorderBrush="#E5E7EB" 
            BorderThickness="0,1,0,0"
            Padding="16,8">
      <Grid ColumnDefinitions="Auto,Auto,*,Auto">
        <!-- Scale Status Indicator -->
        <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
          <!-- Online Indicator -->
          <Ellipse Width="10" Height="10" VerticalAlignment="Center" IsVisible="{Binding IsScaleOnline}">
            <Ellipse.Fill>
              <SolidColorBrush Color="#10B981"/>
            </Ellipse.Fill>
          </Ellipse>
          <!-- Offline Indicator -->
          <Ellipse Width="10" Height="10" VerticalAlignment="Center" IsVisible="{Binding !IsScaleOnline}">
            <Ellipse.Fill>
              <SolidColorBrush Color="#EF4444"/>
            </Ellipse.Fill>
          </Ellipse>
          <TextBlock Text="地磅设备" 
                     FontSize="13" 
                     Foreground="#666"
                     VerticalAlignment="Center"/>
          <!-- Online Status Text -->
          <TextBlock Text="在线" 
                     FontSize="13" 
                     Foreground="#10B981"
                     VerticalAlignment="Center"
                     FontWeight="SemiBold"
                     IsVisible="{Binding IsScaleOnline}"/>
          <!-- Offline Status Text -->
          <TextBlock Text="离线" 
                     FontSize="13" 
                     Foreground="#EF4444"
                     VerticalAlignment="Center"
                     FontWeight="SemiBold"
                     IsVisible="{Binding !IsScaleOnline}"/>
        </StackPanel>
        
        <!-- Camera Status Indicator -->
        <Grid Grid.Column="1" 
              Margin="24,0,0,0"
              VerticalAlignment="Center">
          <StackPanel Orientation="Horizontal" 
                      Spacing="8" 
                      VerticalAlignment="Center"
                      Name="CameraStatusPanel"
                      PointerEntered="CameraStatusPanel_OnPointerEntered"
                      PointerExited="CameraStatusPanel_OnPointerExited">
            <!-- Online Indicator -->
            <Ellipse Width="10" Height="10" VerticalAlignment="Center" IsVisible="{Binding IsCameraOnline}">
              <Ellipse.Fill>
                <SolidColorBrush Color="#10B981"/>
              </Ellipse.Fill>
            </Ellipse>
            <!-- Offline Indicator -->
            <Ellipse Width="10" Height="10" VerticalAlignment="Center" IsVisible="{Binding !IsCameraOnline}">
              <Ellipse.Fill>
                <SolidColorBrush Color="#EF4444"/>
              </Ellipse.Fill>
            </Ellipse>
            <TextBlock Text="摄像头" 
                       FontSize="13" 
                       Foreground="#666"
                       VerticalAlignment="Center"/>
            <!-- Online Status Text -->
            <TextBlock Text="在线" 
                       FontSize="13" 
                       Foreground="#10B981"
                       VerticalAlignment="Center"
                       FontWeight="SemiBold"
                       IsVisible="{Binding IsCameraOnline}"/>
            <!-- Offline Status Text -->
            <TextBlock Text="离线" 
                       FontSize="13" 
                       Foreground="#EF4444"
                       VerticalAlignment="Center"
                       FontWeight="SemiBold"
                       IsVisible="{Binding !IsCameraOnline}"/>
          </StackPanel>
          
          <!-- Camera Status Popup -->
          <Popup Name="CameraStatusPopup"
                 Placement="Bottom"
                 IsLightDismissEnabled="False"
                 HorizontalOffset="0"
                 VerticalOffset="2"
                 PointerEntered="CameraStatusPopup_OnPointerEntered"
                 PointerExited="CameraStatusPopup_OnPointerExited">
            <views:CameraStatusPopup DataContext="{Binding}"/>
          </Popup>
        </Grid>
        
        <!-- Right side info (can be extended later) -->
        <TextBlock Grid.Column="3" 
                   Text="{Binding CurrentTime, StringFormat='{}{0:yyyy-MM-dd HH:mm:ss}'}" 
                   FontSize="12" 
                   Foreground="#999"
                   VerticalAlignment="Center"/>
      </Grid>
    </Border>
  </Grid>
</Window>
