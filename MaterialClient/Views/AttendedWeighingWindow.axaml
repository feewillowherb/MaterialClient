<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:entities="using:MaterialClient.Common.Entities"
        x:Class="MaterialClient.Views.AttendedWeighingWindow"
        Title="有人值守"
        Width="1200" Height="800">
  <Grid RowDefinitions="Auto,*" ColumnDefinitions="*">
    <!-- Header -->
    <Border Background="#0F172A" Padding="16">
      <TextBlock Text="有人值守" Foreground="White" FontSize="20"/>
    </Border>

    <!-- Content -->
    <Grid Grid.Row="1" ColumnDefinitions="2*,2*,3*" RowDefinitions="*">
      <!-- Unmatched Records (WeighingRecordType == Unmatch) -->
      <StackPanel Margin="12" Spacing="8">
        <TextBlock Text="未完成 (称重记录)" FontWeight="Bold"/>
        <ListBox ItemsSource="{Binding UnmatchedWeighingRecords}" SelectedItem="{Binding SelectedWeighingRecord}">
          <ListBox.ItemTemplate>
            <DataTemplate x:DataType="entities:WeighingRecord">
              <StackPanel Orientation="Horizontal" Spacing="8">
                <TextBlock Text="{Binding PlateNumber, TargetNullValue='(空)'}"/>
                <TextBlock Text="{Binding Weight, StringFormat='{}{0:F2} kg'}"/>
              </StackPanel>
            </DataTemplate>
          </ListBox.ItemTemplate>
        </ListBox>
      </StackPanel>

      <!-- Completed Waybills -->
      <StackPanel Grid.Column="1" Margin="12" Spacing="8">
        <TextBlock Text="已完成 (运单)" FontWeight="Bold"/>
        <ListBox ItemsSource="{Binding CompletedWaybills}" SelectedItem="{Binding SelectedWaybill}">
          <ListBox.ItemTemplate>
            <DataTemplate x:DataType="entities:Waybill">
              <StackPanel Orientation="Horizontal" Spacing="8">
                <TextBlock Text="{Binding OrderNo}"/>
                <TextBlock Text="{Binding PlateNumber, TargetNullValue='(空)'}"/>
              </StackPanel>
            </DataTemplate>
          </ListBox.ItemTemplate>
        </ListBox>
      </StackPanel>

      <!-- Detail Panel -->
      <Border Grid.Column="2" Margin="12" BorderBrush="#E5E7EB" BorderThickness="1" Padding="12">
        <Grid RowDefinitions="Auto,Auto,Auto,*,Auto" ColumnDefinitions="*">
          <TextBlock Text="详情" FontWeight="Bold"/>

          <!-- WeighingRecord details -->
          <StackPanel Grid.Row="1" Spacing="8" IsVisible="{Binding IsWeighingRecordSelected}" Margin="0,0,0,12">
            <TextBlock Text="称重记录详情" FontWeight="SemiBold" FontSize="16"/>
            <Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto,Auto" RowSpacing="6">
              <TextBlock Grid.Row="0" Grid.Column="0" Text="车牌号:" Margin="0,0,8,0"/>
              <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding SelectedWeighingRecord.PlateNumber, TargetNullValue='(空)'}"/>
              <TextBlock Grid.Row="1" Grid.Column="0" Text="毛重:" Margin="0,0,8,0"/>
              <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding SelectedWeighingRecord.Weight, StringFormat='{}{0:F2} kg'}"/>
              <TextBlock Grid.Row="2" Grid.Column="0" Text="进场时间:" Margin="0,0,8,0"/>
              <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding SelectedWeighingRecord.CreationTime, StringFormat='{}{0:yyyy-MM-dd HH:mm:ss}'}"/>
            </Grid>
          </StackPanel>

          <!-- Waybill details -->
          <StackPanel Grid.Row="2" Spacing="8" IsVisible="{Binding IsWaybillSelected}" Margin="0,0,0,12">
            <TextBlock Text="运单详情" FontWeight="SemiBold" FontSize="16"/>
            <Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto,Auto,Auto" RowSpacing="6">
              <TextBlock Grid.Row="0" Grid.Column="0" Text="订单号:" Margin="0,0,8,0"/>
              <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding SelectedWaybill.OrderNo}"/>
              <TextBlock Grid.Row="1" Grid.Column="0" Text="车牌号:" Margin="0,0,8,0"/>
              <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding SelectedWaybill.PlateNumber, TargetNullValue='(空)'}"/>
              <TextBlock Grid.Row="2" Grid.Column="0" Text="进场时间:" Margin="0,0,8,0"/>
              <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding SelectedWaybill.JoinTime, StringFormat='{}{0:yyyy-MM-dd HH:mm:ss}'}"/>
              <TextBlock Grid.Row="3" Grid.Column="0" Text="出场时间:" Margin="0,0,8,0"/>
              <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding SelectedWaybill.OutTime, StringFormat='{}{0:yyyy-MM-dd HH:mm:ss}'}"/>
            </Grid>
          </StackPanel>

          <!-- Photos area (vehicle / bill) -->
          <Grid Grid.Row="3" ColumnDefinitions="*,*" RowDefinitions="Auto,*" Margin="0,12,0,0">
            <!-- Vehicle Photos -->
            <StackPanel Grid.Column="0" Margin="8">
              <TextBlock Text="车辆照片" FontWeight="SemiBold" Margin="0,0,0,8"/>
              <ScrollViewer MaxHeight="300">
                <ItemsControl ItemsSource="{Binding VehiclePhotos}">
                  <ItemsControl.ItemTemplate>
                    <DataTemplate x:DataType="System:String">
                      <Border BorderBrush="#D1D5DB" BorderThickness="1" Margin="0,0,0,8" Padding="4">
                        <Image Source="{Binding}" MaxWidth="200" MaxHeight="150" Stretch="Uniform"/>
                      </Border>
                    </DataTemplate>
                  </ItemsControl.ItemTemplate>
                </ItemsControl>
              </ScrollViewer>
            </StackPanel>
            
            <!-- Bill Photo -->
            <StackPanel Grid.Column="1" Margin="8">
              <TextBlock Text="票据照片" FontWeight="SemiBold" Margin="0,0,0,8"/>
              <Border BorderBrush="#D1D5DB" BorderThickness="1" Height="200" Padding="4">
                <Image Source="{Binding BillPhotoPath}" Stretch="Uniform" HorizontalAlignment="Center" VerticalAlignment="Center"/>
              </Border>
            </StackPanel>
          </Grid>

          <StackPanel Grid.Row="4" Orientation="Horizontal" Spacing="8" HorizontalAlignment="Right" Margin="0,12,0,0">
            <Button Content="刷新" Command="{Binding RefreshCommand}"/>
          </StackPanel>
        </Grid>
      </Border>
    </Grid>
  </Grid>
</Window>
