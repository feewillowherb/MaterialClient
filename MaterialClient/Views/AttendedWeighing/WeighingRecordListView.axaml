<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:MaterialClient.ViewModels"
             xmlns:models="using:MaterialClient.Common.Models"
             xmlns:converters="using:MaterialClient.Converters"
             xmlns:u="https://irihi.tech/ursa"
             x:Class="MaterialClient.Views.AttendedWeighing.WeighingRecordListView"
             x:DataType="vm:AttendedWeighingViewModel">

    <UserControl.Resources>
        <converters:EqualityToColorConverter x:Key="EqualityToColorConverter" />
    </UserControl.Resources>

    <!-- Left Column: Record List -->
    <Border Background="#F8F9FA"
            BorderBrush="#E5E7EB"
            BorderThickness="0,0,1,0"
            Padding="0">
        <Grid RowDefinitions="Auto,Auto,*">
            <!-- Tab Headers -->
            <Border Grid.Row="0" Background="White" BorderBrush="#E5E7EB" BorderThickness="0,0,0,1">
                <StackPanel Orientation="Horizontal" Spacing="0">
                    <Button Content="全部记录"
                            Classes="tab-button"
                            Classes.active="{Binding IsShowAllRecords}"
                            BorderThickness="0,0,0,3"
                            Padding="24,12"
                            FontSize="14"
                            Command="{Binding ShowAllRecordsCommand}" />
                    <Button Content="未完成"
                            Classes="tab-button"
                            Classes.active="{Binding IsShowUnmatched}"
                            BorderThickness="0,0,0,3"
                            Padding="24,12"
                            FontSize="14"
                            Command="{Binding ShowUnmatchedCommand}" />
                    <Button Content="已完成"
                            Classes="tab-button"
                            Classes.active="{Binding IsShowCompleted}"
                            BorderThickness="0,0,0,3"
                            Padding="24,12"
                            FontSize="14"
                            Command="{Binding ShowCompletedCommand}" />
                </StackPanel>
            </Border>

            <!-- Search Box -->
            <Border Grid.Row="1"
                    Classes="card-border"
                    Margin="12,12,12,8"
                    Padding="12">
                <Grid RowDefinitions="Auto,Auto,Auto,Auto">

                    <!-- Row 1: 进场时间 + 开始日期时间选择器 -->
                    <Grid Grid.Row="0"
                          ColumnDefinitions="Auto,Auto"
                          Margin="0,0,0,8">
                        <TextBlock Text="进场时间"
                                   VerticalAlignment="Center"
                                   Margin="0,0,8,0"
                                   FontSize="13"
                                   Foreground="#666" />
                        <u:DateTimePicker Grid.Column="1"
                                          Width="150"
                                          FontSize="10"
                                          Margin="0,0,8,0"
                                          SelectedDate="{Binding SearchStartDate}"
                                          DisplayFormat="yyyy-MM-dd HH:mm"
                                          PanelFormat="yyyy-MM-dd HH:mm" />
                    </Grid>

                    <!-- Row 2: 结束日期时间选择器 -->
                    <Grid Grid.Row="1"
                          ColumnDefinitions="Auto,Auto"
                          Margin="0,0,0,8">
                        <TextBlock Text="进场时间"
                                   VerticalAlignment="Center"
                                   Margin="0,0,8,0"
                                   FontSize="13"
                                   Foreground="#666"
                                   Opacity="0" />
                        <u:DateTimePicker Grid.Column="1"
                                          Width="150"
                                          FontSize="10"
                                          Margin="0,0,8,0"
                                          SelectedDate="{Binding SearchEndDate}"
                                          DisplayFormat="yyyy-MM-dd HH:mm"
                                          PanelFormat="yyyy-MM-dd HH:mm" />
                    </Grid>

                    <!-- Row 3: 车牌号码 + 输入框 -->
                    <Grid Grid.Row="2"
                          ColumnDefinitions="Auto,Auto"
                          Margin="0,0,0,8">
                        <TextBlock Text="车牌号码"
                                   VerticalAlignment="Center"
                                   Margin="0,0,8,0"
                                   FontSize="13"
                                   Foreground="#666" />
                        <TextBox Grid.Column="1"
                                 Width="150"
                                 FontSize="13"
                                 Text="{Binding SearchPlateNumber}" />
                    </Grid>

                    <!-- Row 4: 搜索 + 重置按钮 -->
                    <Grid Grid.Row="3"
                          ColumnDefinitions="Auto,Auto,Auto">
                        <TextBlock Text="进场时间"
                                   VerticalAlignment="Center"
                                   Margin="0,0,8,0"
                                   FontSize="13"
                                   Foreground="#666"
                                   Opacity="0" />
                        <Button Grid.Column="1"
                                Content="搜索"
                                Classes="primary-button"
                                CornerRadius="4"
                                Padding="20,6"
                                FontSize="13"
                                Margin="0,0,4,0"
                                Command="{Binding SearchCommand}" />
                        <Button Grid.Column="2"
                                Content="重置"
                                Classes="secondary-button"
                                CornerRadius="4"
                                Padding="20,6"
                                FontSize="13"
                                Command="{Binding ResetSearchCommand}" />
                    </Grid>
                </Grid>
            </Border>

            <!-- Record List -->
            <Border Grid.Row="2" Classes="card-border" Margin="12,0,12,12">
                <Grid RowDefinitions="Auto,*,Auto">
                    <!-- List Header -->
                    <Border Background="#F8F9FA"
                            BorderBrush="#E5E7EB"
                            BorderThickness="0,0,0,1"
                            Padding="12,8">
                        <Grid ColumnDefinitions="80,*,*">
                            <TextBlock Text="车牌" FontSize="13" FontWeight="SemiBold" Foreground="#666" />
                            <TextBlock Grid.Column="1" Text="进场时间" FontSize="13" FontWeight="SemiBold"
                                       Foreground="#666" />
                            <TextBlock Grid.Column="2" Text="出场时间" FontSize="13" FontWeight="SemiBold"
                                       Foreground="#666" />
                        </Grid>
                    </Border>

                    <!-- Scrollable List - 统一的列表 -->
                    <ScrollViewer Grid.Row="1">
                        <ItemsControl ItemsSource="{Binding PagedListItems}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate x:DataType="models:WeighingListItemDto">
                                    <Button Classes="transparent-button"
                                            BorderThickness="0,0,0,1"
                                            BorderBrush="#F0F0F0"
                                            Padding="12,12"
                                            HorizontalAlignment="Stretch"
                                            HorizontalContentAlignment="Stretch"
                                            Command="{Binding $parent[ItemsControl].((vm:AttendedWeighingViewModel)DataContext).SelectListItemCommand}"
                                            CommandParameter="{Binding}">
                                        <Button.Background>
                                            <MultiBinding Converter="{StaticResource EqualityToColorConverter}">
                                                <Binding Path="." />
                                                <Binding
                                                    Path="$parent[ItemsControl].((vm:AttendedWeighingViewModel)DataContext).SelectedListItem" />
                                            </MultiBinding>
                                        </Button.Background>
                                        <Grid ColumnDefinitions="80,*,*">
                                            <TextBlock Text="{Binding PlateNumber, TargetNullValue='未识别'}"
                                                       FontSize="13"
                                                       Foreground="#333" />
                                            <TextBlock Grid.Column="1"
                                                       Text="{Binding JoinTime, StringFormat='{}{0:MM-dd HH:mm}'}"
                                                       FontSize="13"
                                                       Foreground="#666" />
                                            <TextBlock Grid.Column="2"
                                                       Text="{Binding OutTime, StringFormat='{}{0:MM-dd HH:mm}', TargetNullValue='-'}"
                                                       FontSize="13"
                                                       Foreground="#666" />
                                        </Grid>
                                    </Button>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>

                    <!-- Pagination Controls -->
                    <Border Grid.Row="2"
                            Background="#F8F9FA"
                            BorderBrush="#E5E7EB"
                            BorderThickness="0,1,0,0"
                            Padding="12,8">
                        <Grid ColumnDefinitions="Auto,*,Auto,Auto">
                            <!-- 总记录数信息 -->
                            <TextBlock Grid.Column="0"
                                       Text="{Binding TotalCount, StringFormat='共 {0} 条'}"
                                       FontSize="12"
                                       Foreground="#666"
                                       VerticalAlignment="Center"
                                       Margin="0,0,12,0" />

                            <!-- 页码信息 -->
                            <TextBlock Grid.Column="1"
                                       HorizontalAlignment="Center"
                                       VerticalAlignment="Center"
                                       Text="{Binding PageInfoText}"
                                       FontSize="12"
                                       Foreground="#666" />

                            <!-- 上一页按钮 -->
                            <Button Grid.Column="2"
                                    Content="上一页"
                                    Command="{Binding GoToPreviousPageCommand}"
                                    Classes="outline-button"
                                    CornerRadius="4"
                                    Padding="12,6"
                                    FontSize="12"
                                    Margin="0,0,8,0" />

                            <!-- 下一页按钮 -->
                            <Button Grid.Column="3"
                                    Content="下一页"
                                    Command="{Binding GoToNextPageCommand}"
                                    Classes="outline-button"
                                    CornerRadius="4"
                                    Padding="12,6"
                                    FontSize="12" />
                        </Grid>
                    </Border>
                </Grid>
            </Border>
        </Grid>
    </Border>
</UserControl>