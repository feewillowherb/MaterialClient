# é‡é‡ç¨³å®šæ€§ç›‘æ§ä¼˜åŒ–åˆ†æ

## èƒŒæ™¯

åˆ†æå°†ç¨³å®šæ€§æ£€æŸ¥é¢‘ç‡ä» 100ms æ”¹ä¸º 200ms å¯¹æ•°æ®æ—¶æ•ˆæ€§çš„å½±å“ã€‚

## å½“å‰é…ç½®

- **ç¡¬ä»¶å‘é€é¢‘ç‡**ï¼š100msï¼ˆ10æ¬¡/ç§’ï¼‰
- **ç¨³å®šæ€§çª—å£**ï¼š3ç§’
- **ç¨³å®šé˜ˆå€¼**ï¼šÂ±0.05mï¼ˆæ€»èŒƒå›´0.1mï¼‰
- **å½“å‰æ£€æŸ¥é¢‘ç‡**ï¼š100msï¼ˆ10æ¬¡/ç§’ï¼‰

## å½±å“åˆ†æ

### 1. å“åº”å»¶è¿Ÿå½±å“

| æŒ‡æ ‡ | 100ms | 200ms | å·®å¼‚ |
|------|-------|-------|------|
| æœ€å¤§æ£€æµ‹å»¶è¿Ÿ | 100ms | 200ms | +100ms |
| ç¨³å®šçŠ¶æ€è¯†åˆ«å»¶è¿Ÿ | 3.0-3.1ç§’ | 3.0-3.2ç§’ | +0-0.1ç§’ |
| ä¸ç¨³å®šçŠ¶æ€è¯†åˆ«å»¶è¿Ÿ | 0-100ms | 0-200ms | +100ms |

#### å®é™…å½±å“

**åœºæ™¯1ï¼šè½¦è¾†ä¸Šç£…ï¼ˆä»OffScale â†’ WaitingForStabilityï¼‰**
- 100msï¼šå¹³å‡å»¶è¿Ÿ 50ms
- 200msï¼šå¹³å‡å»¶è¿Ÿ 100ms
- **å½±å“**ï¼šç”¨æˆ·æ„Ÿè§‰ä¸åˆ°å·®å¼‚ï¼ˆ< 200ms éƒ½æ˜¯"ç¬æ—¶"ï¼‰

**åœºæ™¯2ï¼šé‡é‡ç¨³å®šï¼ˆä»WaitingForStability â†’ WeightStabilizedï¼‰**
- 100msï¼š3.05ç§’åè¯†åˆ«
- 200msï¼š3.1ç§’åè¯†åˆ«
- **å½±å“**ï¼šå¤šç­‰ 50msï¼Œå¯¹3ç§’çª—å£æ¥è¯´ä»… 1.6% å·®å¼‚

**åœºæ™¯3ï¼šè½¦è¾†ä¸‹ç£…ï¼ˆä»WeightStabilized â†’ OffScaleï¼‰**
- 100msï¼šå¹³å‡å»¶è¿Ÿ 50ms
- 200msï¼šå¹³å‡å»¶è¿Ÿ 100ms
- **å½±å“**ï¼šä¸‹ç£…æµç¨‹å¤š 50msï¼Œç”¨æˆ·æ— æ„Ÿ

### 2. æ•°æ®é‡‡æ ·å½±å“

#### 100ms æ£€æŸ¥é¢‘ç‡ï¼š
```
3ç§’çª—å£ = 30ä¸ªæ•°æ®ç‚¹
æ£€æŸ¥é¢‘ç‡ = 10æ¬¡/ç§’
æ¯æ¬¡æ£€æŸ¥éƒ½èƒ½çœ‹åˆ°æœ€æ–°æ•°æ®
```

#### 200ms æ£€æŸ¥é¢‘ç‡ï¼š
```
3ç§’çª—å£ = 30ä¸ªæ•°æ®ç‚¹ï¼ˆä¸å˜ï¼‰
æ£€æŸ¥é¢‘ç‡ = 5æ¬¡/ç§’
æ•°æ®ç‚¹æ•°é‡ä¸å˜ï¼Œåªæ˜¯æ£€æŸ¥æ¬¡æ•°å‡åŠ
```

**å…³é”®ç‚¹**ï¼š
- âœ… **Buffer çª—å£å†…çš„æ•°æ®ç‚¹æ•°é‡ä¸å˜**ï¼ˆä»ç„¶æ˜¯30ä¸ªï¼‰
- âœ… **åªæ˜¯åˆ¤æ–­é¢‘ç‡é™ä½**ï¼Œä¸å½±å“æ•°æ®å®Œæ•´æ€§
- âœ… **æ‰€æœ‰ç¡¬ä»¶æ•°æ®éƒ½ä¼šè¢«æ”¶é›†**ï¼Œä¸ä¼šä¸¢å¤±

### 3. ç¨³å®šæ€§åˆ¤æ–­å‡†ç¡®æ€§

```csharp
// Buffer(3ç§’, 0.1ç§’) â†’ Buffer(3ç§’, 0.2ç§’)
// çª—å£å¤§å°ä¸å˜ï¼Œåªæ˜¯å‘å‡ºé¢‘ç‡æ”¹å˜
```

**å‡†ç¡®æ€§å¯¹æ¯”**ï¼š

| æ–¹é¢ | 100ms | 200ms |
|------|-------|-------|
| çª—å£æ•°æ®ç‚¹ | 30ä¸ª | 30ä¸ª âœ… |
| Min/Max è®¡ç®— | ç²¾ç¡® | ç²¾ç¡® âœ… |
| ç¨³å®šé˜ˆå€¼åˆ¤æ–­ | å‡†ç¡® | å‡†ç¡® âœ… |
| è¯¯åˆ¤é£é™© | æä½ | æä½ âœ… |

**ç»“è®º**ï¼šå‡†ç¡®æ€§**å®Œå…¨ç›¸åŒ**ï¼Œå› ä¸ºåˆ¤æ–­ä¾æ®çš„æ•°æ®é›†ç›¸åŒã€‚

### 4. æ€§èƒ½ä¸å†…å­˜å½±å“

| æŒ‡æ ‡ | 100ms | 200ms | èŠ‚çœ |
|------|-------|-------|------|
| Buffer å‘å‡ºæ¬¡æ•° | 10æ¬¡/ç§’ | 5æ¬¡/ç§’ | **50%** â¬‡ï¸ |
| List åˆ†é…æ¬¡æ•° | 10æ¬¡/ç§’ | 5æ¬¡/ç§’ | **50%** â¬‡ï¸ |
| å†…å­˜åˆ†é… | ~5KB/ç§’ | ~2.5KB/ç§’ | **50%** â¬‡ï¸ |
| Subscribe å›è°ƒ | 10æ¬¡/ç§’ | 5æ¬¡/ç§’ | **50%** â¬‡ï¸ |
| æ—¥å¿—å†™å…¥ | 10æ¬¡/ç§’ | 5æ¬¡/ç§’ | **50%** â¬‡ï¸ |

## å®é™…ä¸šåŠ¡åœºæ™¯æµ‹è¯•

### åœºæ™¯1ï¼šè½¦è¾†ä¸Šç£…å¹¶ç¨³å®š

```
æ—¶é—´çº¿ï¼ˆ100msæ£€æŸ¥ï¼‰ï¼š
0.0s  - è½¦è¾†ä¸Šç£…ï¼Œé‡é‡ 0.2t â†’ 5.5t
0.5s  - æ£€æµ‹åˆ° > 0.5tï¼Œè¿›å…¥ WaitingForStability
3.0s  - é‡é‡ç¨³å®šåœ¨ 5.45-5.55t
3.1s  - è¯†åˆ«ä¸º WeightStabilizedï¼Œè§¦å‘æŠ“æ‹

æ—¶é—´çº¿ï¼ˆ200msæ£€æŸ¥ï¼‰ï¼š
0.0s  - è½¦è¾†ä¸Šç£…ï¼Œé‡é‡ 0.2t â†’ 5.5t
0.6s  - æ£€æµ‹åˆ° > 0.5tï¼Œè¿›å…¥ WaitingForStability (+0.1s)
3.0s  - é‡é‡ç¨³å®šåœ¨ 5.45-5.55t
3.2s  - è¯†åˆ«ä¸º WeightStabilizedï¼Œè§¦å‘æŠ“æ‹ (+0.1s)
```

**å·®å¼‚**ï¼šå¤š 0.1-0.2 ç§’ï¼Œå¯¹äºåœ°ç£…ç§°é‡æµç¨‹**å®Œå…¨å¯æ¥å—**ã€‚

### åœºæ™¯2ï¼šä¸ç¨³å®šç§°é‡ï¼ˆè½¦è¾†æœªåœç¨³å°±ä¸‹ç£…ï¼‰

```
æ—¶é—´çº¿ï¼ˆ100msæ£€æŸ¥ï¼‰ï¼š
0.0s  - ä¸Šç£…ï¼Œé‡é‡ä¸Šå‡
0.5s  - è¿›å…¥ WaitingForStability
1.2s  - è½¦è¾†ä¸‹ç£…ï¼Œé‡é‡ < 0.5t
1.3s  - æ£€æµ‹åˆ°å¼‚å¸¸ï¼Œè§¦å‘æŠ“æ‹ (+0.1s)

æ—¶é—´çº¿ï¼ˆ200msæ£€æŸ¥ï¼‰ï¼š
0.0s  - ä¸Šç£…ï¼Œé‡é‡ä¸Šå‡
0.6s  - è¿›å…¥ WaitingForStability
1.2s  - è½¦è¾†ä¸‹ç£…ï¼Œé‡é‡ < 0.5t
1.4s  - æ£€æµ‹åˆ°å¼‚å¸¸ï¼Œè§¦å‘æŠ“æ‹ (+0.2s)
```

**å·®å¼‚**ï¼šå¤š 0.1 ç§’ï¼Œå¯¹å¼‚å¸¸æŠ“æ‹**æ— å®é™…å½±å“**ã€‚

## æ¨èæ–¹æ¡ˆ

### âœ… æ¨èæ”¹ä¸º 200ms

#### ç†ç”±ï¼š

1. **æ—¶æ•ˆæ€§å½±å“å¾®ä¹å…¶å¾®**
   - å¯¹3ç§’çš„ç¨³å®šæ€§åˆ¤æ–­çª—å£ï¼Œ0.1ç§’å»¶è¿Ÿä»… 3.3%
   - ç”¨æˆ·å®Œå…¨æ— æ³•æ„ŸçŸ¥ 100-200ms çš„å·®å¼‚

2. **æ€§èƒ½æ”¶ç›Šæ˜æ˜¾**
   - å‡å°‘ 50% å†…å­˜åˆ†é…
   - å‡å°‘ 50% GC å‹åŠ›
   - å‡å°‘ 50% æ—¥å¿—å†™å…¥

3. **ä¸šåŠ¡éœ€æ±‚å®Œå…¨æ»¡è¶³**
   - åœ°ç£…ç§°é‡ä¸æ˜¯é«˜é¢‘äº¤æ˜“ï¼Œä¸éœ€è¦æ¯«ç§’çº§å“åº”
   - è½¦è¾†ä¸Š/ä¸‹ç£…æœ¬èº«éœ€è¦å‡ ç§’é’Ÿ
   - ç¨³å®šæ€§åˆ¤æ–­æœ¬èº«å°±éœ€è¦ 3 ç§’

4. **ä»£ç æ”¹åŠ¨æå°**
   ```csharp
   // ä»
   .Buffer(TimeSpan.FromSeconds(3), TimeSpan.FromMilliseconds(100))
   // æ”¹ä¸º
   .Buffer(TimeSpan.FromSeconds(3), TimeSpan.FromMilliseconds(200))
   ```

### ä¼˜åŒ–åçš„å®Œæ•´å®ç°

```csharp
/// <summary>
/// Initialize weight stability monitoring using Rx
/// Monitors weight changes within 3 seconds window, considers stable if variation is less than Â±0.1m
/// </summary>
private void InitializeWeightStabilityMonitoring()
{
    _stabilitySubscription?.Dispose();

    _stabilitySubscription = _truckScaleWeightService.WeightUpdates
        .Buffer(TimeSpan.FromSeconds(StabilityWindowSeconds), TimeSpan.FromMilliseconds(200))
        .Subscribe(buffer =>
        {
            if (buffer.Count > 0)
            {
                // æ‰‹åŠ¨è®¡ç®— min/maxï¼Œé¿å… LINQ åˆ†é…
                var min = decimal.MaxValue;
                var max = decimal.MinValue;
                
                foreach (var weight in buffer)
                {
                    if (weight < min) min = weight;
                    if (weight > max) max = weight;
                }
                
                var range = max - min;
                bool isStable = range <= WeightStabilityThreshold * 2;

                lock (_statusLock)
                {
                    _isWeightStable = isStable;
                }

                _logger?.LogDebug(
                    $"Weight stability: {isStable} (range: {range:F2}m, min: {min:F2}m, max: {max:F2}m)");
            }
            else
            {
                lock (_statusLock)
                {
                    _isWeightStable = false;
                }
            }
        });
}
```

## æ€»ç»“å¯¹æ¯”è¡¨

| ç»´åº¦ | 100ms | 200ms | æ¨è |
|------|-------|-------|------|
| æ—¶æ•ˆæ€§ | ğŸŸ¢ ä¼˜ç§€ | ğŸŸ¢ ä¼˜ç§€ | 200ms âœ… |
| å‡†ç¡®æ€§ | ğŸŸ¢ ç²¾ç¡® | ğŸŸ¢ ç²¾ç¡® | ç›¸åŒ |
| å†…å­˜å¼€é”€ | ğŸŸ¡ 5KB/s | ğŸŸ¢ 2.5KB/s | 200ms âœ… |
| CPU å¼€é”€ | ğŸŸ¡ 10æ¬¡/s | ğŸŸ¢ 5æ¬¡/s | 200ms âœ… |
| ç”¨æˆ·ä½“éªŒ | ğŸŸ¢ æ— æ„ŸçŸ¥ | ğŸŸ¢ æ— æ„ŸçŸ¥ | ç›¸åŒ |
| ä»£ç å¤æ‚åº¦ | ğŸŸ¢ ç®€å• | ğŸŸ¢ ç®€å• | ç›¸åŒ |

## ç»“è®º

**æ¨èæ”¹ä¸º 200ms** ğŸ‘

- æ—¶æ•ˆæ€§å½±å“å¯å¿½ç•¥
- æ€§èƒ½æå‡æ˜æ˜¾ï¼ˆå‡å°‘50%å†…å­˜åˆ†é…å’ŒCPUå¼€é”€ï¼‰
- æ€§ä»·æ¯”æœ€é«˜
- å®Œå…¨æ»¡è¶³åœ°ç£…ç§°é‡ä¸šåŠ¡éœ€æ±‚

---

## ç›¸å…³ä»£ç æ–‡ä»¶

- `MaterialClient.Common/Services/AttendedWeighingService.cs` - æœ‰äººå€¼å®ˆç§°é‡æœåŠ¡
- `MaterialClient.Common/Services/Hardware/TruckScaleWeightService.cs` - åœ°ç£…ç¡¬ä»¶æœåŠ¡
- `MaterialClient.Common.Tests/Tests/WeightScaleRxTests.cs` - é‡é‡ç¨³å®šæ€§æµ‹è¯•

## æµ‹è¯•éªŒè¯

æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹ä½¿ç”¨ 100ms ç¡¬ä»¶æ•°æ®å‘é€é—´éš”è¿›è¡ŒéªŒè¯ï¼Œè¯æ˜ 200ms æ£€æŸ¥é¢‘ç‡å®Œå…¨æ»¡è¶³ä¸šåŠ¡éœ€æ±‚ã€‚

æµ‹è¯•ç»“æœï¼š
```
Passed!  - Failed: 0, Passed: 3, Skipped: 0, Total: 3
- Test_WeightStable_WhenDataIsStable
- Test_WeightUnstable_WhenDataFluctuates
- Test_WeightTransition_FromUnstableToStable
```

---

## æ‰©å±•åˆ†æï¼š500ms æ£€æŸ¥é¢‘ç‡

### æ¦‚è¿°

è¿›ä¸€æ­¥åˆ†æå°†æ£€æŸ¥é¢‘ç‡é™ä½åˆ° 500ms çš„å½±å“ï¼Œä¸ 100ms å’Œ 200ms è¿›è¡Œå¯¹æ¯”ã€‚

### 1. å“åº”å»¶è¿Ÿå½±å“å¯¹æ¯”

| æŒ‡æ ‡ | 100ms | 200ms | 500ms | å·®å¼‚ï¼ˆvs 100msï¼‰ |
|------|-------|-------|-------|------------------|
| æœ€å¤§æ£€æµ‹å»¶è¿Ÿ | 100ms | 200ms | 500ms | +400ms |
| å¹³å‡æ£€æµ‹å»¶è¿Ÿ | 50ms | 100ms | 250ms | +200ms |
| ç¨³å®šçŠ¶æ€è¯†åˆ«å»¶è¿Ÿ | 3.0-3.1ç§’ | 3.0-3.2ç§’ | 3.0-3.5ç§’ | +0-0.4ç§’ |
| ä¸ç¨³å®šçŠ¶æ€è¯†åˆ«å»¶è¿Ÿ | 0-100ms | 0-200ms | 0-500ms | +400ms |

#### å®é™…å½±å“

**åœºæ™¯1ï¼šè½¦è¾†ä¸Šç£…ï¼ˆä»OffScale â†’ WaitingForStabilityï¼‰**
- 100msï¼šå¹³å‡å»¶è¿Ÿ 50ms âœ…
- 200msï¼šå¹³å‡å»¶è¿Ÿ 100ms âœ…
- 500msï¼šå¹³å‡å»¶è¿Ÿ 250ms âš ï¸
- **å½±å“**ï¼š250ms ä»åœ¨ç”¨æˆ·å¯æ¥å—èŒƒå›´å†…ï¼Œä½†å¼€å§‹æœ‰è½»å¾®æ„ŸçŸ¥

**åœºæ™¯2ï¼šé‡é‡ç¨³å®šï¼ˆä»WaitingForStability â†’ WeightStabilizedï¼‰**
- 100msï¼š3.05ç§’åè¯†åˆ« âœ…
- 200msï¼š3.1ç§’åè¯†åˆ« âœ…
- 500msï¼š3.25ç§’åè¯†åˆ« âš ï¸
- **å½±å“**ï¼šå¤šç­‰ 250msï¼Œå¯¹3ç§’çª—å£æ¥è¯´çº¦ 8.3% å·®å¼‚ï¼Œå¯æ¥å—

**åœºæ™¯3ï¼šè½¦è¾†ä¸‹ç£…ï¼ˆä»WeightStabilized â†’ OffScaleï¼‰**
- 100msï¼šå¹³å‡å»¶è¿Ÿ 50ms âœ…
- 200msï¼šå¹³å‡å»¶è¿Ÿ 100ms âœ…
- 500msï¼šå¹³å‡å»¶è¿Ÿ 250ms âš ï¸
- **å½±å“**ï¼šä¸‹ç£…æµç¨‹å¤š 250msï¼Œå¼€å§‹æœ‰è½»å¾®æ„ŸçŸ¥

### 2. æ•°æ®é‡‡æ ·å½±å“

#### 500ms æ£€æŸ¥é¢‘ç‡ï¼š
```
3ç§’çª—å£ = 30ä¸ªæ•°æ®ç‚¹ï¼ˆä¸å˜ï¼‰
æ£€æŸ¥é¢‘ç‡ = 2æ¬¡/ç§’
æ•°æ®ç‚¹æ•°é‡ä¸å˜ï¼Œæ£€æŸ¥æ¬¡æ•°é™åˆ°åŸæ¥çš„ 1/5
```

**å¯¹æ¯”åˆ†æ**ï¼š

| æŒ‡æ ‡ | 100ms | 200ms | 500ms |
|------|-------|-------|-------|
| çª—å£æ•°æ®ç‚¹æ•° | 30ä¸ª | 30ä¸ª | 30ä¸ª âœ… |
| æ£€æŸ¥é¢‘ç‡ | 10æ¬¡/ç§’ | 5æ¬¡/ç§’ | 2æ¬¡/ç§’ |
| æ•°æ®å®Œæ•´æ€§ | å®Œæ•´ | å®Œæ•´ | å®Œæ•´ âœ… |
| çŠ¶æ€æ›´æ–°åŠæ—¶æ€§ | å®æ—¶ | å‡†å®æ—¶ | ç•¥æœ‰å»¶è¿Ÿ âš ï¸ |

**å…³é”®è§‚å¯Ÿ**ï¼š
- âœ… æ•°æ®ç‚¹æ•°é‡ä»ç„¶ä¸å˜ï¼ˆ30ä¸ªï¼‰
- âœ… æ‰€æœ‰ç¡¬ä»¶æ•°æ®éƒ½ä¼šè¢«æ”¶é›†
- âš ï¸ çŠ¶æ€æ›´æ–°å»¶è¿Ÿè¾¾åˆ° 0.5 ç§’ï¼Œå¯èƒ½å½±å“ UI åˆ·æ–°æµç•…åº¦

### 3. ç¨³å®šæ€§åˆ¤æ–­å‡†ç¡®æ€§

**å‡†ç¡®æ€§å¯¹æ¯”**ï¼š

| æ–¹é¢ | 100ms | 200ms | 500ms |
|------|-------|-------|-------|
| çª—å£æ•°æ®ç‚¹ | 30ä¸ª | 30ä¸ª | 30ä¸ª âœ… |
| Min/Max è®¡ç®— | ç²¾ç¡® | ç²¾ç¡® | ç²¾ç¡® âœ… |
| ç¨³å®šé˜ˆå€¼åˆ¤æ–­ | å‡†ç¡® | å‡†ç¡® | å‡†ç¡® âœ… |
| è¯¯åˆ¤é£é™© | æä½ | æä½ | æä½ âœ… |
| åˆ¤æ–­åŸºå‡† | ç›¸åŒ | ç›¸åŒ | ç›¸åŒ âœ… |

**ç»“è®º**ï¼šå‡†ç¡®æ€§**å®Œå…¨ç›¸åŒ**ï¼Œå› ä¸ºåˆ¤æ–­ä¾æ®çš„æ•°æ®é›†å®Œå…¨ä¸€è‡´ã€‚

### 4. æ€§èƒ½ä¸å†…å­˜å½±å“

| æŒ‡æ ‡ | 100ms | 200ms | 500ms | èŠ‚çœï¼ˆvs 100msï¼‰ |
|------|-------|-------|-------|------------------|
| Buffer å‘å‡ºæ¬¡æ•° | 10æ¬¡/ç§’ | 5æ¬¡/ç§’ | 2æ¬¡/ç§’ | **80%** â¬‡ï¸â¬‡ï¸ |
| List åˆ†é…æ¬¡æ•° | 10æ¬¡/ç§’ | 5æ¬¡/ç§’ | 2æ¬¡/ç§’ | **80%** â¬‡ï¸â¬‡ï¸ |
| å†…å­˜åˆ†é… | ~5KB/ç§’ | ~2.5KB/ç§’ | ~1KB/ç§’ | **80%** â¬‡ï¸â¬‡ï¸ |
| Subscribe å›è°ƒ | 10æ¬¡/ç§’ | 5æ¬¡/ç§’ | 2æ¬¡/ç§’ | **80%** â¬‡ï¸â¬‡ï¸ |
| æ—¥å¿—å†™å…¥ | 10æ¬¡/ç§’ | 5æ¬¡/ç§’ | 2æ¬¡/ç§’ | **80%** â¬‡ï¸â¬‡ï¸ |
| CPU å‘¨æœŸ | åŸºå‡† | -50% | -80% | **æ˜¾è‘—é™ä½** ğŸŸ¢ |

**æ€§èƒ½æ”¶ç›Š**ï¼š
- âœ… å†…å­˜åˆ†é…é™ä½ 80%ï¼ŒGC å‹åŠ›å¤§å¹…å‡è½»
- âœ… CPU å¼€é”€é™ä½ 80%ï¼Œé€‚åˆèµ„æºå—é™ç¯å¢ƒ
- âœ… æ—¥å¿— I/O å‡å°‘ 80%ï¼Œé™ä½ç£ç›˜å‹åŠ›

### 5. å®é™…ä¸šåŠ¡åœºæ™¯æµ‹è¯•

#### åœºæ™¯1ï¼šè½¦è¾†ä¸Šç£…å¹¶ç¨³å®šï¼ˆå®Œæ•´æµç¨‹ï¼‰

```
æ—¶é—´çº¿ï¼ˆ100msæ£€æŸ¥ï¼‰ï¼š
0.0s  - è½¦è¾†ä¸Šç£…ï¼Œé‡é‡ 0.2t â†’ 5.5t
0.5s  - æ£€æµ‹åˆ° > 0.5tï¼Œè¿›å…¥ WaitingForStability
3.0s  - é‡é‡ç¨³å®šåœ¨ 5.45-5.55t
3.1s  - è¯†åˆ«ä¸º WeightStabilizedï¼Œè§¦å‘æŠ“æ‹
      - æ€»å»¶è¿Ÿï¼š3.1ç§’

æ—¶é—´çº¿ï¼ˆ200msæ£€æŸ¥ï¼‰ï¼š
0.0s  - è½¦è¾†ä¸Šç£…ï¼Œé‡é‡ 0.2t â†’ 5.5t
0.6s  - æ£€æµ‹åˆ° > 0.5tï¼Œè¿›å…¥ WaitingForStability (+0.1s)
3.0s  - é‡é‡ç¨³å®šåœ¨ 5.45-5.55t
3.2s  - è¯†åˆ«ä¸º WeightStabilizedï¼Œè§¦å‘æŠ“æ‹ (+0.1s)
      - æ€»å»¶è¿Ÿï¼š3.2ç§’

æ—¶é—´çº¿ï¼ˆ500msæ£€æŸ¥ï¼‰ï¼š
0.0s  - è½¦è¾†ä¸Šç£…ï¼Œé‡é‡ 0.2t â†’ 5.5t
1.0s  - æ£€æµ‹åˆ° > 0.5tï¼Œè¿›å…¥ WaitingForStability (+0.5s)
3.0s  - é‡é‡ç¨³å®šåœ¨ 5.45-5.55t
3.5s  - è¯†åˆ«ä¸º WeightStabilizedï¼Œè§¦å‘æŠ“æ‹ (+0.4s)
      - æ€»å»¶è¿Ÿï¼š3.5ç§’
```

**å·®å¼‚åˆ†æ**ï¼š
- 500ms ç›¸æ¯” 100msï¼šå¤š 0.4 ç§’ï¼ˆ+12.9%ï¼‰
- 500ms ç›¸æ¯” 200msï¼šå¤š 0.3 ç§’ï¼ˆ+9.4%ï¼‰
- **è¯„ä¼°**ï¼šå¯¹äºåœ°ç£…ç§°é‡æµç¨‹ï¼Œ0.4 ç§’å»¶è¿Ÿ**ä»ç„¶å¯æ¥å—**

#### åœºæ™¯2ï¼šå¿«é€Ÿæ£€æµ‹åœºæ™¯ï¼ˆå¼‚å¸¸ä¸‹ç£…ï¼‰

```
æ—¶é—´çº¿ï¼ˆ100msæ£€æŸ¥ï¼‰ï¼š
0.0s  - ä¸Šç£…ï¼Œé‡é‡ä¸Šå‡
0.5s  - è¿›å…¥ WaitingForStability
1.2s  - è½¦è¾†ä¸‹ç£…ï¼Œé‡é‡ < 0.5t
1.3s  - æ£€æµ‹åˆ°å¼‚å¸¸ï¼Œè§¦å‘æŠ“æ‹
      - å¼‚å¸¸æ£€æµ‹å»¶è¿Ÿï¼š0.1s

æ—¶é—´çº¿ï¼ˆ200msæ£€æŸ¥ï¼‰ï¼š
0.0s  - ä¸Šç£…ï¼Œé‡é‡ä¸Šå‡
0.6s  - è¿›å…¥ WaitingForStability
1.2s  - è½¦è¾†ä¸‹ç£…ï¼Œé‡é‡ < 0.5t
1.4s  - æ£€æµ‹åˆ°å¼‚å¸¸ï¼Œè§¦å‘æŠ“æ‹
      - å¼‚å¸¸æ£€æµ‹å»¶è¿Ÿï¼š0.2s

æ—¶é—´çº¿ï¼ˆ500msæ£€æŸ¥ï¼‰ï¼š
0.0s  - ä¸Šç£…ï¼Œé‡é‡ä¸Šå‡
1.0s  - è¿›å…¥ WaitingForStability
1.2s  - è½¦è¾†ä¸‹ç£…ï¼Œé‡é‡ < 0.5t
1.7s  - æ£€æµ‹åˆ°å¼‚å¸¸ï¼Œè§¦å‘æŠ“æ‹
      - å¼‚å¸¸æ£€æµ‹å»¶è¿Ÿï¼š0.5s âš ï¸
```

**å·®å¼‚åˆ†æ**ï¼š
- 500ms å»¶è¿Ÿè¾¾åˆ° 0.5 ç§’ï¼Œåœ¨å¿«é€Ÿåœºæ™¯ä¸‹**è¾ƒä¸ºæ˜æ˜¾**
- å¯èƒ½å½±å“å¼‚å¸¸æŠ“æ‹çš„åŠæ—¶æ€§
- **è¯„ä¼°**ï¼šå¯¹äºå¼‚å¸¸æ£€æµ‹åœºæ™¯ï¼Œ500ms çš„å»¶è¿Ÿ**ç•¥æ˜¾ä¸è¶³**

### 6. UI å“åº”ä½“éªŒ

| æ£€æŸ¥é¢‘ç‡ | çŠ¶æ€æ›´æ–°å»¶è¿Ÿ | UI æµç•…åº¦ | ç”¨æˆ·æ„ŸçŸ¥ |
|----------|--------------|-----------|----------|
| 100ms | 0-100ms | éå¸¸æµç•… | æ— æ„ŸçŸ¥ ğŸŸ¢ |
| 200ms | 0-200ms | æµç•… | æ— æ„ŸçŸ¥ ğŸŸ¢ |
| 500ms | 0-500ms | ç•¥æœ‰å¡é¡¿æ„Ÿ | è½»å¾®æ„ŸçŸ¥ ğŸŸ¡ |

**åˆ†æ**ï¼š
- å¦‚æœ UI éœ€è¦å®æ—¶æ˜¾ç¤ºé‡é‡ç¨³å®šçŠ¶æ€ï¼ˆå¦‚æŒ‡ç¤ºç¯ã€è¿›åº¦æ¡ï¼‰
- 500ms å¯èƒ½å¯¼è‡´ UI æ›´æ–°ç•¥æ˜¾è¿Ÿé’
- å¯¹äºéå®æ—¶ UI åœºæ™¯ï¼Œ500ms ä»å¯æ¥å—

### 7. æ¨èå»ºè®®

#### ğŸ’¡ 500ms é€‚ç”¨åœºæ™¯

**âœ… æ¨èä½¿ç”¨ 500ms çš„åœºæ™¯**ï¼š
1. **èµ„æºå—é™ç¯å¢ƒ**
   - åµŒå…¥å¼è®¾å¤‡æˆ–ä½é…ç½®ç¡¬ä»¶
   - å†…å­˜å’ŒCPUèµ„æºç´§å¼ 
   - éœ€è¦é•¿æ—¶é—´è¿ç»­è¿è¡Œ

2. **åå°ç›‘æ§åœºæ™¯**
   - æ— éœ€å®æ—¶ UI åé¦ˆ
   - æ‰¹é‡æ•°æ®è®°å½•
   - æœåŠ¡å™¨ç«¯ç›‘æ§

3. **ä½ä¼˜å…ˆçº§ä»»åŠ¡**
   - å¤‡ç”¨ç›‘æ§é€šé“
   - ç»Ÿè®¡æ•°æ®æ”¶é›†
   - éå…³é”®ä¸šåŠ¡è·¯å¾„

**âŒ ä¸æ¨èä½¿ç”¨ 500ms çš„åœºæ™¯**ï¼š
1. **ç”¨æˆ·äº¤äº’åœºæ™¯**
   - éœ€è¦å®æ—¶ UI çŠ¶æ€åé¦ˆ
   - æ“ä½œå‘˜ä¾èµ–è§†è§‰æŒ‡ç¤º
   - å¿«é€Ÿå“åº”è¦æ±‚é«˜

2. **å¼‚å¸¸æ£€æµ‹å…³é”®è·¯å¾„**
   - ä¸ç¨³å®šç§°é‡æŠ“æ‹
   - å®‰å…¨ç›‘æ§
   - é˜²ä½œå¼Šæ£€æµ‹

3. **é«˜å¹¶å‘ç§°é‡ç«™**
   - å¿«é€Ÿè¿‡ç£…éœ€æ±‚
   - è½¦æµé‡å¤§
   - æ•ˆç‡è¦æ±‚é«˜

#### ğŸ“Š ä¸‰ç§æ–¹æ¡ˆç»¼åˆå¯¹æ¯”

| è¯„ä¼°ç»´åº¦ | 100ms | 200ms | 500ms |
|----------|-------|-------|-------|
| **æ—¶æ•ˆæ€§** | ğŸŸ¢ğŸŸ¢ğŸŸ¢ ä¼˜ç§€ | ğŸŸ¢ğŸŸ¢ğŸŸ¢ ä¼˜ç§€ | ğŸŸ¡ğŸŸ¡ è‰¯å¥½ |
| **å‡†ç¡®æ€§** | ğŸŸ¢ğŸŸ¢ğŸŸ¢ ç²¾ç¡® | ğŸŸ¢ğŸŸ¢ğŸŸ¢ ç²¾ç¡® | ğŸŸ¢ğŸŸ¢ğŸŸ¢ ç²¾ç¡® |
| **å†…å­˜æ•ˆç‡** | ğŸŸ¡ ä¸€èˆ¬ | ğŸŸ¢ğŸŸ¢ è‰¯å¥½ | ğŸŸ¢ğŸŸ¢ğŸŸ¢ ä¼˜ç§€ |
| **CPU æ•ˆç‡** | ğŸŸ¡ ä¸€èˆ¬ | ğŸŸ¢ğŸŸ¢ è‰¯å¥½ | ğŸŸ¢ğŸŸ¢ğŸŸ¢ ä¼˜ç§€ |
| **UI æµç•…åº¦** | ğŸŸ¢ğŸŸ¢ğŸŸ¢ æµç•… | ğŸŸ¢ğŸŸ¢ğŸŸ¢ æµç•… | ğŸŸ¡ å¯æ¥å— |
| **ç”¨æˆ·ä½“éªŒ** | ğŸŸ¢ğŸŸ¢ğŸŸ¢ æ— æ„ŸçŸ¥ | ğŸŸ¢ğŸŸ¢ğŸŸ¢ æ— æ„ŸçŸ¥ | ğŸŸ¡ è½»å¾®æ„ŸçŸ¥ |
| **ä»£ç å¤æ‚åº¦** | ğŸŸ¢ ç®€å• | ğŸŸ¢ ç®€å• | ğŸŸ¢ ç®€å• |
| **é€‚ç”¨åœºæ™¯** | é€šç”¨ | **é€šç”¨ï¼ˆæ¨èï¼‰** | ç‰¹å®šåœºæ™¯ |

### 8. æœ€ç»ˆæ¨è

#### ğŸ¯ é»˜è®¤æ¨èï¼š**200ms**

**ç†ç”±**ï¼š
- âœ… æ—¶æ•ˆæ€§å’Œæ€§èƒ½çš„æœ€ä½³å¹³è¡¡ç‚¹
- âœ… ç”¨æˆ·ä½“éªŒæ— å½±å“
- âœ… æ€§èƒ½æå‡ 50%ï¼Œæ”¶ç›Šæ˜æ˜¾
- âœ… é€‚ç”¨äº 95% çš„ä¸šåŠ¡åœºæ™¯

#### ğŸ”§ å¯é€‰æ–¹æ¡ˆï¼š**500ms**

**ä½¿ç”¨æ¡ä»¶**ï¼š
- èµ„æºå—é™ç¯å¢ƒï¼ˆåµŒå…¥å¼ã€ä½é…è®¾å¤‡ï¼‰
- åå°ç›‘æ§ï¼Œæ— å®æ—¶ UI éœ€æ±‚
- ç»è¿‡å……åˆ†æµ‹è¯•éªŒè¯

**é…ç½®æ–¹å¼**ï¼š
```csharp
// å¯é€šè¿‡é…ç½®æ–‡ä»¶åŠ¨æ€æ§åˆ¶
private const int StabilityCheckIntervalMs = 200; // é»˜è®¤ 200ms

_stabilitySubscription = _truckScaleWeightService.WeightUpdates
    .Buffer(
        TimeSpan.FromSeconds(StabilityWindowSeconds), 
        TimeSpan.FromMilliseconds(StabilityCheckIntervalMs))
    .Subscribe(buffer => { ... });
```

#### âš ï¸ ä¸æ¨èï¼š**100ms**

**ç†ç”±**ï¼š
- æ€§èƒ½æ”¶ç›Šæœ‰é™ï¼ˆç›¸æ¯” 200msï¼‰
- é¢å¤–å¼€é”€ä¸å€¼å¾—
- å¯¹ç”¨æˆ·ä½“éªŒæå‡å‡ ä¹ä¸ºé›¶

### 9. æ€§èƒ½åŸºå‡†æµ‹è¯•å»ºè®®

å¦‚æœè€ƒè™‘ä½¿ç”¨ 500msï¼Œå»ºè®®è¿›è¡Œä»¥ä¸‹æµ‹è¯•ï¼š

#### æµ‹è¯•ç”¨ä¾‹

```csharp
[Theory]
[InlineData(100)] // 100ms
[InlineData(200)] // 200ms
[InlineData(500)] // 500ms
public async Task Test_WeightStability_WithDifferentCheckIntervals(int intervalMs)
{
    // æ¨¡æ‹Ÿç›¸åŒçš„æ•°æ®æµ
    // æµ‹è¯•ä¸åŒæ£€æŸ¥é—´éš”çš„å½±å“
    // éªŒè¯å‡†ç¡®æ€§å’Œæ—¶æ•ˆæ€§
}
```

#### ç›‘æ§æŒ‡æ ‡

1. **å“åº”æ—¶é—´**ï¼šä»çŠ¶æ€å˜åŒ–åˆ°è¯†åˆ«çš„å»¶è¿Ÿ
2. **å†…å­˜ä½¿ç”¨**ï¼šGC åˆ†é…å’Œå›æ”¶é¢‘ç‡
3. **CPU ä½¿ç”¨**ï¼šSubscribe å›è°ƒçš„ CPU æ—¶é—´
4. **UI å“åº”**ï¼šçŠ¶æ€æ›´æ–°åˆ° UI åˆ·æ–°çš„å»¶è¿Ÿ

---

## æ€»ç»“ä¸å»ºè®®

### æœ€ä½³å®è·µ

1. **é»˜è®¤é…ç½®**ï¼šä½¿ç”¨ **200ms** ä½œä¸ºæ ‡å‡†é…ç½®
2. **å¯é…ç½®åŒ–**ï¼šå°†æ£€æŸ¥é—´éš”è®¾ä¸ºå¯é…ç½®å‚æ•°
3. **æ€§èƒ½ç›‘æ§**ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒç›‘æ§å®é™…è¡¨ç°
4. **æ¸è¿›ä¼˜åŒ–**ï¼šå…ˆä½¿ç”¨ 200msï¼Œæœ‰éœ€æ±‚å†è€ƒè™‘ 500ms

### é…ç½®å»ºè®®

```csharp
// appsettings.json
{
  "WeightStability": {
    "WindowSeconds": 3,
    "CheckIntervalMs": 200,  // å¯è°ƒæ•´ä¸º 100/200/500
    "StabilityThreshold": 0.05
  }
}
```

### ä»£ç å®ç°å»ºè®®

```csharp
private void InitializeWeightStabilityMonitoring()
{
    _stabilitySubscription?.Dispose();

    // ä»é…ç½®è¯»å–æ£€æŸ¥é—´éš”
    var checkInterval = _configuration.GetValue<int>(
        "WeightStability:CheckIntervalMs", 
        200); // é»˜è®¤ 200ms

    _stabilitySubscription = _truckScaleWeightService.WeightUpdates
        .Buffer(
            TimeSpan.FromSeconds(StabilityWindowSeconds), 
            TimeSpan.FromMilliseconds(checkInterval))
        .Subscribe(buffer =>
        {
            if (buffer.Count > 0)
            {
                var min = decimal.MaxValue;
                var max = decimal.MinValue;
                
                foreach (var weight in buffer)
                {
                    if (weight < min) min = weight;
                    if (weight > max) max = weight;
                }
                
                var range = max - min;
                bool isStable = range <= WeightStabilityThreshold * 2;

                lock (_statusLock)
                {
                    _isWeightStable = isStable;
                }

                _logger?.LogDebug(
                    $"Weight stability: {isStable} (range: {range:F2}m, interval: {checkInterval}ms)");
            }
            else
            {
                lock (_statusLock)
                {
                    _isWeightStable = false;
                }
            }
        });
}
```

---

*åˆ›å»ºæ—¶é—´ï¼š2025-12-11*
*æ›´æ–°æ—¶é—´ï¼š2025-12-11ï¼ˆæ·»åŠ  500ms åˆ†æï¼‰*

