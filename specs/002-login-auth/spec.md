# Feature Specification: 登录和授权

**Feature Branch**: `002-login-auth`  
**Created**: 2025-11-07  
**Status**: Draft  
**Input**: User description: "登录和授权"

## Clarifications

### Session 2025-11-07

- Q: 授权码输入窗口关闭行为 - 如果用户在未输入授权码的情况下关闭授权窗口，系统应如何响应？ → A: 直接退出应用程序（用户需要重新启动才能再次输入）
- Q: 网络连接失败处理 - 在验证授权码或用户登录时，如果无法连接到服务器，系统如何处理？ → A: 显示友好错误提示（如"网络连接失败，请检查网络设置"），提供"重试"按钮，允许用户多次尝试
- Q: 密码修改后的本地凭证处理 - 如果用户在其他地方修改了密码，本地保存的密码将失效，系统如何处理？ → A: 显示"用户名或密码错误"提示，清除本地保存的密码，要求用户重新输入
- Q: 并发登录控制策略 - 同一个账号是否允许在多台设备上同时登录？ → A: 允许同一账号在多台设备同时登录，不做限制
- Q: 项目ID变更处理 - 如果授权码对应的项目ID与本地保存的项目ID不一致，系统如何处理？ → A: 使用新授权码的项目ID覆盖本地保存的项目ID，清除旧项目关联的登录凭证和会话数据，要求用户重新登录

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 首次使用授权激活 (Priority: P1)

用户首次启动桌面应用程序时，需要输入授权码来激活软件，确保软件的合法使用。只有通过授权验证后，用户才能使用系统的其他功能。

**Why this priority**: 这是软件使用的前置条件，没有授权验证就无法使用系统的任何功能，是最高优先级的用户场景。

**Independent Test**: 可以通过启动未授权的应用程序，输入正确或错误的授权码，验证系统是否正确处理授权流程并保存授权信息。

**Acceptance Scenarios**:

1. **Given** 用户首次启动应用程序且没有有效授权信息，**When** 系统检测到无授权，**Then** 系统自动弹出授权码输入窗口
2. **Given** 用户在授权码输入窗口中输入了有效的授权码，**When** 点击确认，**Then** 系统验证授权码成功，保存授权信息到数据库，并进入登录页面
3. **Given** 用户输入了无效的授权码，**When** 点击确认，**Then** 系统显示错误提示，要求用户重新输入，不允许进入登录页面
4. **Given** 用户已有有效的授权信息在数据库中，**When** 启动应用程序，**Then** 系统跳过授权码输入，直接进入登录页面

---

### User Story 2 - 用户账号密码登录 (Priority: P2)

用户使用账号和密码登录系统，访问称重管理功能。系统支持"记住密码"功能，方便用户下次快速登录。

**Why this priority**: 授权验证通过后，用户登录是访问系统功能的必要步骤，是第二优先级的核心场景。

**Independent Test**: 可以在授权验证通过后，使用正确或错误的账号密码进行登录测试，验证登录逻辑和"记住密码"功能是否正常工作。

**Acceptance Scenarios**:

1. **Given** 用户在登录页面，**When** 输入正确的用户名和密码并点击登录，**Then** 系统验证成功，进入称重管理主界面
2. **Given** 用户输入了错误的用户名或密码，**When** 点击登录，**Then** 系统显示错误提示，不允许进入系统
3. **Given** 用户勾选了"记住密码"选项并成功登录，**When** 下次启动应用程序并进入登录页面，**Then** 系统自动填充上次保存的用户名和密码
4. **Given** 用户未勾选"记住密码"选项，**When** 下次启动应用程序，**Then** 登录页面为空，需要用户重新输入

---

### User Story 3 - 授权过期处理 (Priority: P3)

当软件授权到期后，系统需要提示用户重新进行授权验证，确保软件的持续合法使用。

**Why this priority**: 授权管理的后续维护场景，虽然重要但不如首次授权和日常登录紧急。

**Independent Test**: 可以通过修改数据库中的授权到期时间，测试系统是否正确检测授权过期并要求重新输入授权码。

**Acceptance Scenarios**:

1. **Given** 数据库中的授权信息已过期，**When** 用户启动应用程序，**Then** 系统检测到授权过期，弹出授权码输入窗口，要求重新授权
2. **Given** 用户输入了新的有效授权码，**When** 验证通过，**Then** 系统更新数据库中的授权信息，允许用户进入登录页面

---

### Edge Cases

- **授权码验证失败时的重试限制**：系统是否限制授权码输入错误的次数？错误多次后是否锁定？
- **网络连接失败**：验证授权码或用户登录时无法连接到服务器时，系统显示友好错误提示（如"网络连接失败，请检查网络设置"），并提供"重试"按钮允许用户多次尝试。
- **并发登录**：系统允许同一账号在多台设备上同时登录，不进行会话限制或冲突检测。
- **授权码输入窗口关闭**：用户在未输入授权码情况下关闭授权窗口时，系统直接退出应用程序，用户需要重新启动才能再次尝试授权。
- **密码修改后的记住密码功能**：当用户使用本地保存的密码登录失败时，系统显示"用户名或密码错误"提示，自动清除本地保存的密码，要求用户重新输入。
- **项目ID变更**：当新授权码对应的项目ID与本地保存的不一致时，系统使用新的项目ID覆盖旧数据，清除旧项目关联的登录凭证和会话数据，要求用户重新登录。

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统启动时必须检查本地数据库中是否存在有效的授权信息（LicenseInfo.AuthEndTime未过期）
- **FR-002**: 当不存在有效授权信息时，系统必须显示授权码输入窗口，阻止用户访问其他功能，直到授权验证成功
- **FR-003**: 当用户在未完成授权验证的情况下关闭授权码输入窗口时，系统必须直接退出应用程序
- **FR-004**: 系统必须能够调用基础平台的授权验证接口（/api/AuthClientLicense/GetAuthClientLicense），提交产品代码（固定为5000）和用户输入的授权码
- **FR-005**: 授权验证成功后，系统必须将返回的授权信息（LicenseInfo）完整保存到本地数据库，包括项目ID、授权Token、授权到期时间、机器码
- **FR-006**: 当新授权码对应的项目ID与本地已保存的项目ID不一致时，系统必须使用新的项目ID覆盖旧数据，并清除旧项目关联的所有登录凭证和会话数据
- **FR-007**: 当存在有效授权信息时，系统必须跳过授权码输入步骤，直接进入登录页面
- **FR-008**: 系统必须提供用户登录界面，允许用户输入用户名和密码
- **FR-009**: 系统必须能够调用基础平台的用户登录接口（/User/UserLogin），提交用户名、密码和项目ID进行身份验证
- **FR-010**: 登录成功后，系统必须保存用户的登录信息（LoginUserDto），包括用户ID、用户名、真实姓名、Token等，用于后续的业务操作
- **FR-011**: 系统必须提供"记住密码"选项，当用户勾选时，将用户名和密码加密保存到本地数据库
- **FR-012**: 当用户启动应用程序且"记住密码"已启用时，系统必须自动填充上次保存的用户名和密码到登录页面
- **FR-013**: 当用户使用本地保存的凭证登录失败时，系统必须自动清除本地保存的用户名和密码，显示"用户名或密码错误"提示，并清空登录表单要求用户重新输入
- **FR-014**: 基础平台的服务器地址（host）必须可在配置文件（appsettings.json）中修改，不硬编码在代码中
- **FR-015**: 登录成功后，系统必须隐藏登录窗口，显示称重管理主界面（AttendedWeighingWindow）
- **FR-016**: 系统必须在授权验证或用户登录失败时，显示清晰的错误提示信息，告知用户失败原因
- **FR-017**: 当授权验证或用户登录过程中发生网络连接失败时，系统必须显示友好的错误提示（如"网络连接失败，请检查网络设置"）并提供"重试"按钮，允许用户重新尝试连接
- **FR-018**: 原有的MainWindow.axaml页面必须被隐藏或移除，不再作为应用程序的入口
- **FR-019**: 系统必须在每次启动时验证授权到期时间，如果已过期，重新要求用户输入授权码

### Key Entities

- **LicenseInfo（授权信息）**: 记录软件的授权状态，包括项目ID、授权Token、授权到期时间、机器码。用于验证软件的合法使用期限。
- **UserCredential（用户凭证）**: 保存用户的登录凭证，包括用户名、加密后的密码、是否记住密码的标志。用于实现"记住密码"功能。
- **LoginUserDto（登录用户信息）**: 存储用户登录后返回的用户详细信息，包括用户ID、用户名、真实姓名、公司信息、Token、授权到期时间等。用于后续业务操作的身份识别和权限控制。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 首次使用的用户能够在2分钟内完成授权码输入和验证流程，成功进入登录页面
- **SC-002**: 已授权用户能够在30秒内完成登录流程，进入称重管理主界面
- **SC-003**: 使用"记住密码"功能的用户，下次启动应用程序时，登录页面能在1秒内自动填充用户名和密码
- **SC-004**: 授权验证或登录失败时，系统在3秒内显示明确的错误提示信息
- **SC-005**: 90%的用户在首次使用时能够顺利完成授权和登录流程，无需额外的技术支持
- **SC-006**: 授权到期检测的准确率达到100%，不允许使用过期授权的软件访问系统功能

## Assumptions *(optional)*

- 假设用户在使用软件前已经从服务提供商处获取了有效的授权码
- 假设用户的计算机能够连接到互联网，以便调用基础平台的API进行授权和登录验证
- 假设基础平台的API服务稳定可用，响应时间在5秒以内
- 假设用户名采用手机号格式（根据API文档中的注释）
- 假设密码保存采用对称加密算法（如AES），密钥存储在本地配置中
- 假设同一授权码只能在一台设备上激活使用（基于机器码验证）

## Out of Scope *(optional)*

以下功能不在本次开发范围内：

- 用户注册功能（用户账号由管理员在基础平台中创建）
- 密码重置/找回功能（通过基础平台的Web界面处理）
- 多语言支持（当前仅支持简体中文）
- 单点登录（SSO）集成
- 生物识别登录（指纹、面部识别等）
- 移动端授权和登录
- 离线授权验证模式
- 授权转移功能（将授权从一台设备转移到另一台）
- 并发登录会话管理（检测或限制同一账号在多设备的登录）

## Dependencies *(optional)*

- **基础平台API服务**: 依赖基础平台提供的授权验证接口（/api/AuthClientLicense/GetAuthClientLicense）和用户登录接口（/User/UserLogin）
- **数据库**: 依赖本地数据库存储授权信息、用户凭证和登录会话
- **配置文件**: 依赖appsettings.json配置文件存储基础平台的服务器地址
- **网络连接**: 依赖稳定的网络连接来调用远程API

## Security & Compliance *(optional)*

- **密码存储安全**: "记住密码"功能必须使用加密算法保存密码，不得以明文形式存储
- **通信安全**: 与基础平台API的通信应使用HTTPS协议，确保数据传输安全
- **授权Token保护**: 登录后获取的Token应安全存储，防止被恶意程序窃取
- **机器码绑定**: 授权码验证时使用机器码，防止授权被非法转移到其他设备
- **会话管理**: Token应有合理的有效期，过期后要求用户重新登录
- **失败重试限制**: 考虑对授权验证和登录失败次数进行限制，防止暴力破解攻击

## Notes *(optional)*

- 参考UI设计位于 `/assets/AuthCode.xaml` 和 `/assets/Login.xaml`
- 原有的MainWindow.axaml将不再作为应用程序入口，新的启动流程为：授权验证 → 登录 → AttendedWeighingWindow
- 基础平台host默认为 `http://base.publicapi.findong.com`，但应该支持在配置文件中修改
- ProductCode固定为"5000"，用于标识本称重管理系统产品

